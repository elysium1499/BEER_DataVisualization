<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.0">
<title>Comparing countries | CO‚ÇÇ emissions</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="./_observablehq/client.7782eb36.js">
<link rel="modulepreload" href="./_observablehq/runtime.9393ab6d.js">
<link rel="modulepreload" href="./_observablehq/stdlib.3ee9cb94.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/7055d4c5.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.7e044bdc.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.16/e828d8c8.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/063eb405.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/c68fbd73.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e95f898e.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/d44feff9.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/5830b12a.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/84d7b8e9.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/2c0cdfa2.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/626bedc4.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/00c41b5d.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/b5f7cdc6.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/b22c5864.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/6f15f633.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/ef1ec490.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e1ff060.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/5851d7ef.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/dcd02767.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/f1db2593.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/034b7bcb.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/4bb53638.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/bbafde58.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/aa5b35a8.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/32c7fec2.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/567840a0.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/cf9b720b.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/5dcd62f4.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/f8e03c56.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/5bc129e1.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/19c92b44.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/f31b5398.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/8debb4ba.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/4b0cc581.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/a62ae5ce.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/5eed35fd.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/e67acb27.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/1ee6c50d.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/8ac9039b.js">
<link rel="icon" href="./_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.7782eb36.js";
import {registerFile} from "./_observablehq/stdlib.3ee9cb94.js";

registerFile("./data/co-emissions-per-capita-filter.csv", {"name":"./data/co-emissions-per-capita-filter.csv","mimeType":"text/csv","path":"./_file/data/co-emissions-per-capita-filter.9f9ae678.csv","lastModified":1731700104052,"size":179331});
registerFile("./data/co2-fossil-plus-land-use.csv", {"name":"./data/co2-fossil-plus-land-use.csv","mimeType":"text/csv","path":"./_file/data/co2-fossil-plus-land-use.14870976.csv","lastModified":1731701676493,"size":316369});
registerFile("./data/region_entities.csv", {"name":"./data/region_entities.csv","mimeType":"text/csv","path":"./_file/data/region_entities.6897ee96.csv","lastModified":1731701143960,"size":4099});
registerFile("./data/region_entities_population2022.csv", {"name":"./data/region_entities_population2022.csv","mimeType":"text/csv","path":"./_file/data/region_entities_population2022.444e37a4.csv","lastModified":1732613650930,"size":5854});

define({id: "f920bdb6", inputs: ["FileAttachment"], outputs: ["dataset","RegionDataset","populationDataset","datasetFossil"], body: async (FileAttachment) => {
//column: Entity,Code,Year,Annual CO‚ÇÇ emissions (per capita)
const dataset = FileAttachment("./data/co-emissions-per-capita-filter.csv").csv({typed: true});
//column: Entity,Region
const RegionDataset = FileAttachment("./data/region_entities.csv").csv({typed: true});
//column: Entity,Region,Population
const populationDataset = FileAttachment("./data/region_entities_population2022.csv").csv({typed: true});
//column: Entity,Region,Code,Year,Annual CO‚ÇÇ emissions,Annual CO‚ÇÇ emissions from land-use change,Annual CO‚ÇÇ emissions from fossil fuel
const datasetFossil = await FileAttachment("./data/co2-fossil-plus-land-use.csv").csv({ typed: true });

return {dataset,RegionDataset,populationDataset,datasetFossil};
}});

define({id: "08d4b376", inputs: ["dataset","view","Inputs","Plot"], outputs: ["uniqueEntities","year","EmissionsByCapitalYear"], body: (dataset,view,Inputs,Plot) => {
const uniqueEntities = [...new Set(dataset.map(d => d.Year.toString()))].sort((a, b) => b - a);
const year = view(Inputs.select(uniqueEntities, {label: "üìÖ Choose Year"}));


function EmissionsByCapitalYear(data, year, { width¬†=¬†800¬†}¬†=¬†{}) {
  const filteredData = data
    .filter(d => d.Year.toString() === year)
    .map(d => ({
      city: d.Entity,
      co2Emissions: +d["Annual CO‚ÇÇ emissions (per capita)"]
    }))
    .sort((a, b) => b.co2Emissions - a.co2Emissions)
    .slice(0, 20);

    const colorPalette = "#2E8B57";


    const coloredData = filteredData.map((cityData, index) => ({
        ...cityData,
        color: colorPalette
    }));

    return Plot.plot({
        height: 400,
        width,
        marginLeft: 60,
        marginBottom: 130,
        x: {
            label: "Country",
            domain: coloredData.map(d => d.city),
            tickRotate: -45,
            tickSize: 10 
        },
        y: {
            label: "Annual CO‚ÇÇ Emissions (per capita) - Billion tons",
            grid: true, 
            tickFormat: d => `${d} BT`
        },
        marks: [
            Plot.barY(coloredData, { 
                x: "city", 
                y: "co2Emissions", 
                fill: "color"
            })
        ]
    });
}

return {uniqueEntities,year,EmissionsByCapitalYear};
}});

define({id: "c5890bb6", mode: "inline", inputs: ["resize","EmissionsByCapitalYear","dataset","year","display"], body: async (resize,EmissionsByCapitalYear,dataset,year,display) => {
display(await(
resize((width) => EmissionsByCapitalYear(dataset, year, {width}))
))
}});

define({id: "f90a5d74", inputs: ["Plot"], outputs: ["EmissionsByCapital"], body: (Plot) => {
function EmissionsByCapital(data, { width = 800 } = {}) {
    const totalEmissions = data
        .filter(d => d.Year >= 2011 && d.Year <= 2022)
        .reduce((acc, d) => {
            const city = d.Entity;
            const emissions = +d["Annual CO‚ÇÇ emissions (per capita)"];

            if (!acc[city]) {
                acc[city] = { city, co2Emissions: 0 };
            }
            acc[city].co2Emissions += emissions;
            return acc;
        }, {});

    const topCities = Object.values(totalEmissions)
        .sort((a, b) => b.co2Emissions - a.co2Emissions)
        .slice(0, 20);

    const uniqueEmissions = [...new Set(topCities.map(d => d.co2Emissions))];

    const colorPalette = "#4682B4";

    const emissionColorMap = {};
    uniqueEmissions.forEach((emission, index) => {
        emissionColorMap[emission] = colorPalette;
    });

    const coloredCities = topCities.map(cityData => ({
        ...cityData,
        color: emissionColorMap[cityData.co2Emissions]
    }));

    return Plot.plot({
        height: 400,
        width,
        marginLeft: 150,
        marginBottom: 60,
        x: {
            label: "Total CO‚ÇÇ Emissions (per capita) - Billion Tons",
            grid: true,
            nice: true, 
            tickFormat: d => `${d} BT`
        },
        y: {
            label: "Country",
            labelPosition: "top",
            domain: coloredCities.map(d => d.city),
            tickRotate: 0
        },
        marks: [
            Plot.barX(coloredCities, { 
                x: "co2Emissions", 
                y: "city", 
                fill: "color"
            })
        ]
    });
}

return {EmissionsByCapital};
}});

define({id: "a24953ee", mode: "inline", inputs: ["resize","EmissionsByCapital","dataset","display"], body: async (resize,EmissionsByCapital,dataset,display) => {
display(await(
resize((width) => EmissionsByCapital(dataset, {width}))
))
}});

define({id: "ab7fc716", inputs: ["populationDataset","Plot"], outputs: ["prepareStackedData","EmissionsByRegionStacked"], body: (populationDataset,Plot) => {
function prepareStackedData(data, regionsData) {
  const mergedData = data.filter(d => d.Year === 2022).map(d => {
    const regionData = regionsData.find(region => region.Entity === d.Entity);
    const populationData = populationDataset.find(pop => pop.Entity === d.Entity);
    return {
      city: d.Entity,
      co2Emissions: +d["Annual CO‚ÇÇ emissions (per capita)"]* (populationData.Population2022)/ 1_000_000_000,
      region: regionData ? regionData.Region : "Unknown"
    };
  });

  return mergedData;
}

function EmissionsByRegionStacked(data, regionsData, { width = 800 } = {}) {
  const preparedData = prepareStackedData(data, regionsData);
  const totalEmissionsByEntity = preparedData.reduce((acc, d) => {
    if (!acc[d.city]) {
      acc[d.city] = { co2Emissions: 0, region: d.region };
    }
    acc[d.city].co2Emissions += d.co2Emissions;
    return acc;
  }, {});

  const topCities = Object.values(
    Object.entries(totalEmissionsByEntity)
      .reduce((acc, [city, { co2Emissions, region }]) => {
        if (!acc[region]) acc[region] = [];
        acc[region].push({ city, co2Emissions, region });
        return acc;
      }, {})
  ).map(citiesInRegion => {
    const sortedCities = citiesInRegion.sort((a, b) => b.co2Emissions - a.co2Emissions);
    const top5Cities = sortedCities.slice(0, 5);
    const otherCitiesSum = sortedCities.slice(5).reduce((sum, city) => sum + city.co2Emissions, 0);
    return [...top5Cities, { city: 'Other Countries', co2Emissions: otherCitiesSum, region: top5Cities[0].region }];
  }).flat();

  const colorPalette = ["#CC564D", "#D4AC40", "#800080", "#4FAAC4", "#008000"];

  const cityColorMap = {};
  topCities.forEach(d => {
    if (d.city === "Other Countries") {
      cityColorMap[d.city] = "#303080";
    } else {
      const cityIndex = topCities.filter(c => c.region === d.region).indexOf(d);
      cityColorMap[d.city] = colorPalette[cityIndex];
    }
  });

  const regionData = {};

  topCities.forEach(d => {
    if (!regionData[d.region]) {
      regionData[d.region] = {
        region: d.region,
        co2Emissions: 0,
        cities: []
      };
    }
    regionData[d.region].co2Emissions += d.co2Emissions;

    if (!regionData[d.region].cities.some(city => city.city === d.city)) {
      regionData[d.region].cities.push({
        city: d.city,
        co2Emissions: d.co2Emissions,
        color: cityColorMap[d.city]
      });
    }
  });

  const finalData = Object.values(regionData).sort((a, b) => b.co2Emissions - a.co2Emissions);

  return Plot.plot({
    width,
    height: 500,
    marginLeft: 100,
    //marginRight: 250,
    marginBottom: 60,
    x: {
      label: "Total Annual CO‚ÇÇ Emissions (per capita) - Billion Tons",
      grid: true,
      tickSpacing: 50,
      tickFormat: d => `${d} BT`
    },
    y: {
      label: "Continent",
      domain: finalData.map(d => d.region),
      labelPosition: "top"
    },
    color: {
      domain: ["First Emitter", "Second Emitter", "Third Emitter"],
      range: colorPalette.slice(0, 3).concat("#303080"), // Usa i primi tre colori dell'array colorPalette e un colore per "Other Countries"
      legend: true,
      labelAnchor: "center",
      textAlign: "center"
    },
    marks: [
      Plot.barX(topCities, {
        x: "co2Emissions",
        y: d => d.region,
        fill: d => cityColorMap[d.city],
        title: d => `${d.city}: ${d.co2Emissions.toFixed(4)} Billion Tons of CO‚ÇÇ`,
        tip: true
      })
    ],
    style: {
      legend: {
        position: "top",   // Posiziona la legenda sopra il grafico
        offset: 10,        // Regola la distanza tra la legenda e il grafico
        textAlign: "center" // Centra la legenda orizzontalmente
      }
    }
  });
}
return {prepareStackedData,EmissionsByRegionStacked};
}});

define({id: "0f6b3f90", mode: "inline", inputs: ["resize","EmissionsByRegionStacked","dataset","RegionDataset","display"], body: async (resize,EmissionsByRegionStacked,dataset,RegionDataset,display) => {
display(await(
resize((width) => EmissionsByRegionStacked(dataset, RegionDataset, { width }))
))
}});

define({id: "40695053", inputs: ["populationDataset","Plot"], outputs: ["colorPalette","prepareData","calculateRegionalEmissions","selectTopCities","rankEmittersByPosition","generateMiniDatasets","applyColorPaletteMiniDatasets","createSubplot","generateLabels","createSubplotContainer","EmissionsByRegionStackedMultiple"], body: (populationDataset,Plot) => {
const colorPalette = ["#CC564D", "#D4AC40", "#800080", "#6B8E23"];

// Step 1: Data Preparation
function prepareData(data, regionsData) {
    return data.map(d => {
        const regionData = regionsData.find(region => region.Entity === d.Entity);
        const populationData = populationDataset.find(pop => pop.Entity === d.Entity);
        return {
            city: d.Entity,
            co2Emissions: +d["Annual CO‚ÇÇ emissions (per capita)"] * (populationData.Population2022)/ 1_000_000_000,
            region: regionData ? regionData.Region : "Unknown"
        };
    });
}


// Step 2: Calculate total CO‚ÇÇ emissions for each city within a region
function calculateRegionalEmissions(preparedData) {
    return preparedData.reduce((acc, record) => {
        const { region, city, co2Emissions } = record;

        if (!acc[region]) {
            acc[region] = {};
        }
        if (!acc[region][city]) {
            acc[region][city] = 0;
        }
        acc[region][city] += co2Emissions;
        return acc;
    }, {});
}

function selectTopCities(totalEmissionsByRegion, topN, includeOther = false, includeTotal = false) {
    let topCitiesByRegion = {};

    // Step 1: Build top cities for each region
    for (const region in totalEmissionsByRegion) {
       
        const sortedCities = Object.entries(totalEmissionsByRegion[region])
            .map(([city, co2Emissions]) => ({ city, co2Emissions, region }))
            .filter(cityData => cityData.co2Emissions > 0)
            .sort((a, b) => b.co2Emissions - a.co2Emissions);

        topCitiesByRegion[region] = sortedCities.slice(0, topN);

        const totalEmissions = sortedCities.reduce((sum, city) => sum + city.co2Emissions, 0);
        topCitiesByRegion[region].push({ city: "Total", co2Emissions: totalEmissions, region });
    }

    // Step 2: Sort regions by total emissions in descending order
    const sortedRegions = Object.entries(topCitiesByRegion)
        .map(([region, cities]) => {
            const totalEmissions = cities.reduce((sum, city) => sum + city.co2Emissions, 0);
            return { region, cities, totalEmissions };
        })
        .sort((a, b) => b.totalEmissions - a.totalEmissions);

    // Step 3: Rebuild topCitiesByRegion in sorted order
    topCitiesByRegion = Object.fromEntries(sortedRegions.map(({ region, cities }) => [region, cities]));

    return topCitiesByRegion;
}


// Step 4: Rank emitters by position across regions
function rankEmittersByPosition(topCitiesByRegion) {
    const rankedEmitters = [];
    const maxLength = Math.max(...Object.values(topCitiesByRegion).map(region => region.length));

    for (let position = 0; position < maxLength; position++) {
        const emittersAtPosition = {};

        for (const region in topCitiesByRegion) {
            const cityData = topCitiesByRegion[region][position];
            if (cityData) {
                if (!emittersAtPosition[region]) {
                    emittersAtPosition[region] = [];
                }
                emittersAtPosition[region].push(cityData);
            }
        }

        rankedEmitters.push(emittersAtPosition);
    }

    return rankedEmitters;
}

// Step 5: Generate mini-datasets based on ranked emitters for subplots
function generateMiniDatasets(topCitiesByRegion) {
    const rankedEmitters = rankEmittersByPosition(topCitiesByRegion);
    return rankedEmitters.map((emitters, index) => ({
        rank: index + 1,
        data: emitters
    }));
}

// Step 6: Apply a unique color to each dataset
function applyColorPaletteMiniDatasets(miniDatasets, colorPalette) {
    miniDatasets.forEach((dataset, index) => {
        dataset.color = colorPalette[index % colorPalette.length];
    });
}

// Step 7: Create a single subplot for a mini-dataset with optional text labels and centered x-axis label
function createSubplot(data, orderedRegions, label, width, height, showYAxisLabels, color, showText = true) {
    return Plot.plot({
        width,
        height,
        marginLeft: showYAxisLabels ? 100 : 20,
        marginBottom: 80,
        x: {
            label,
            labelAnchor: "center",
            grid: true,
            tickFormat: "s",
            tickSpacing: 50,
            tickFormat: d => `${d} BT`
        },
        y: {
            domain: orderedRegions,
            label: showYAxisLabels ? "Continent" : null,
            labelPosition: "top",
            ticks: showYAxisLabels ? orderedRegions : [],
        },
        marks: [
            Plot.barX(data, {
                x: "co2Emissions",
                y: "region",
                fill: color,
                title: d => `${d.city}: ${d.co2Emissions.toFixed(2)} Billion Tons of CO‚ÇÇ`,
                tip: true
            }),
        ]
    });
}



// Dynamically generate labels based on `topNPerRegion`
function generateLabels(topNPerRegion) {
    const rankLabels = ["First", "Second", "Third"];
    const labels = rankLabels.slice(0, topNPerRegion);
    labels.push("Total emissions");
    return labels;
}

// Step 8: Create container with subplots, applying a unique color for each subplot
function createSubplotContainer(miniDatasets, orderedRegions, width, height, topNPerRegion) {
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.gap = "20px";

    // Generate appropriate labels
    const labels = generateLabels(topNPerRegion);

    miniDatasets.forEach((dataset, index) => {
        const subplotWidth = index === miniDatasets.length - 1 ? (width / miniDatasets.length) * 2 : width / miniDatasets.length;
        const data = orderedRegions.flatMap(region => dataset.data[region] || []);
        
        const label = labels[index];
        const showYAxisLabels = index === 0;
        const showText = index < miniDatasets.length - 2;
        const subplot = createSubplot(data, orderedRegions, label, subplotWidth, height, showYAxisLabels, dataset.color, showText);
        
        const subplotContainer = document.createElement("div");
        subplotContainer.appendChild(subplot);
        container.appendChild(subplotContainer);
    });

    return container;
}


// Main function to create the full visualization with modularized steps
function EmissionsByRegionStackedMultiple(data, regionsData, { width = 1600, height = 500, topNPerRegion } = {}) {
    // Step 1-3: Data preparation and processing
    const preparedData = prepareData(data, regionsData);
    const regionalEmissions = calculateRegionalEmissions(preparedData);
    const topCitiesByRegion = selectTopCities(regionalEmissions, topNPerRegion, true, true);

    // Step 4-5: Generate mini-datasets based on rankings
    const miniDatasets = generateMiniDatasets(topCitiesByRegion);
    
    // Define orderedRegions after miniDatasets are generated
    const orderedRegions = Object.keys(miniDatasets[miniDatasets.length - 1].data)
        .sort((a, b) => miniDatasets[miniDatasets.length - 1].data[b][0].co2Emissions - miniDatasets[miniDatasets.length - 1].data[a][0].co2Emissions);

    // Step 6: Apply a unique color to each mini-dataset
    applyColorPaletteMiniDatasets(miniDatasets, colorPalette);

    // Step 7-8: Create and return container with subplots
    return createSubplotContainer(miniDatasets, orderedRegions, width, height, topNPerRegion);
}
return {colorPalette,prepareData,calculateRegionalEmissions,selectTopCities,rankEmittersByPosition,generateMiniDatasets,applyColorPaletteMiniDatasets,createSubplot,generateLabels,createSubplotContainer,EmissionsByRegionStackedMultiple};
}});

define({id: "2832f044", mode: "inline", inputs: ["resize","EmissionsByRegionStackedMultiple","dataset","RegionDataset","display"], body: async (resize,EmissionsByRegionStackedMultiple,dataset,RegionDataset,display) => {
display(await(
resize(width => EmissionsByRegionStackedMultiple(dataset, RegionDataset, { width, topNPerRegion: 3 }))
))
}});

define({id: "2f881621", inputs: ["prepareStackedData","Plot"], outputs: ["EmissionsByRegionStackedPercentage"], body: (prepareStackedData,Plot) => {
function EmissionsByRegionStackedPercentage(data, regionsData, { width = 800 } = {}) {
  const preparedData = prepareStackedData(data, regionsData);
  
  const totalEmissionsByEntity = preparedData.reduce((acc, d) => {
    if (!acc[d.city]) {
      acc[d.city] = { co2Emissions: 0, region: d.region };
    }
    acc[d.city].co2Emissions += d.co2Emissions;
    return acc;
  }, {});

  const totalEmissionsByRegion = Object.values(totalEmissionsByEntity).reduce((acc, { co2Emissions, region }) => {
    acc[region] = (acc[region] || 0) + co2Emissions;
    return acc;
  }, {});

  const topCities = Object.values(
    Object.entries(totalEmissionsByEntity)
      .reduce((acc, [city, { co2Emissions, region }]) => {
        if (!acc[region]) acc[region] = [];
        acc[region].push({ city, co2Emissions, region });
        return acc;
      }, {})
  ).map(citiesInRegion => {
      const sortedCities = citiesInRegion.sort((a, b) => b.co2Emissions - a.co2Emissions);
      const top5Cities = sortedCities.slice(0, 5);
      const otherCitiesSum = sortedCities.slice(5).reduce((sum, city) => sum + city.co2Emissions, 0);
      return [
        ...top5Cities, 
        { city: 'Other Countries', co2Emissions: otherCitiesSum, region: top5Cities[0].region }
      ];
    }).flat();

  const colorPalette = ["#CC564D", "#D4AC40", "#800080", "#4FAAC4", "#008000"];

  const cityColorMap = {};
  topCities.forEach(d => {
    if (d.city === "Other Countries") {
      cityColorMap[d.city] = "#303080";
    } else {
      const cityIndex = topCities.filter(c => c.region === d.region).indexOf(d);
      cityColorMap[d.city] = colorPalette[cityIndex];
    }
  });

  const topCitiesWithPercentage = topCities.map(d => ({
    ...d,
    co2EmissionsPercentage: (d.co2Emissions / totalEmissionsByRegion[d.region]) * 100
  }));

  const regionData = {};

  topCitiesWithPercentage.forEach(d => {
    if (!regionData[d.region]) {
      regionData[d.region] = {
        region: d.region,
        co2Emissions: 0,
        cities: []
      };
    }
    regionData[d.region].co2Emissions += d.co2Emissions;

    if (!regionData[d.region].cities.some(city => city.city === d.city)) {
      regionData[d.region].cities.push({
        city: d.city,
        co2EmissionsPercentage: d.co2EmissionsPercentage,
        color: cityColorMap[d.city]
      });
    }
  });

  const finalData = Object.values(regionData).sort((a, b) => b.co2Emissions - a.co2Emissions);

  return Plot.plot({
    width,
    height: 500,
    marginLeft: 100,
    marginBottom: 60,
    x: {
        label: "Percentage of Total continental CO‚ÇÇ Emissions",
        tickSpacing: 50,
        tickFormat: d => `${d}%`
    },
    y: {
      label: "Continent",
      domain: finalData.map(d => d.region),
      labelPosition: "top"
    },
    marks: [
      Plot.barX(topCitiesWithPercentage, {
        x: "co2EmissionsPercentage",
        y: d => d.region,
        fill: d => cityColorMap[d.city],
        title: d => `${d.city}: ${d.co2EmissionsPercentage.toFixed(2)}% emissions`,
        tip: true
      })
    ]
  });
}


return {EmissionsByRegionStackedPercentage};
}});

define({id: "f17805dc", mode: "inline", inputs: ["resize","EmissionsByRegionStackedPercentage","dataset","RegionDataset","display"], body: async (resize,EmissionsByRegionStackedPercentage,dataset,RegionDataset,display) => {
display(await(
resize((width) => EmissionsByRegionStackedPercentage(dataset, RegionDataset, { width }))
))
}});

define({id: "5115dc54", inputs: ["Plot","d3","datasetFossil"], outputs: ["prepareDataForYear","renderHeatmap","initializeDropdown","autoPlayInterval","toggleAutoPlay"], body: (Plot,d3,datasetFossil) => {
// Prepare the data for the selected year and top countries
function prepareDataForYear(data, year) {
  return data
    .filter(d => d.Year === year)
    .map(d => ({
      country: d.Entity,
      region: d.Region,
      year,
      fossilEmissions: +d["Annual CO‚ÇÇ emissions from fossil fuel"] / 1e9,       // Normalizing to billion tons
      landUseEmissions: +d["Annual CO‚ÇÇ emissions from land-use change"] / 1e9, // Normalizing to billion tons
      totalEmissions: +d["Annual CO‚ÇÇ emissions"] / 1e9 // Total emissions
    }))
    .sort((a, b) => b.totalEmissions - a.totalEmissions) // Sort by total emissions
    .slice(0, 10) // Top 10 countries by total emissions
    .flatMap(d => [
      { country: d.country, yearAndType: `${year} (Fossil Fuel)`, emissions: d.fossilEmissions },
      { country: d.country, yearAndType: `${year} (Land-Use)`, emissions: d.landUseEmissions },
      { country: d.country, yearAndType: `${year} (Total)`, emissions: d.totalEmissions } // Add total emissions
    ]);
}

// Generate and render the heatmap based on the selected year
function renderHeatmap(data, year) {
  const heatmapData = prepareDataForYear(data, year);
  const heatmap = Plot.plot({
    width: 1000, // Increase width for bigger cells
    height: 300, // Increase height for bigger cells
    marginLeft: 150,
    marginBottom: 100,
    marginTop: 50,
    style: {
      fontSize: "14px", // Keep font size readable
      color: "white"
    },
    x: {
      label: "Country",
      domain: [...new Set(heatmapData.map(d => d.country))],
      tickRotate: -30,
      labelAnchor: "center",
      paddingInner: 0.1 // Adjust spacing between columns for bigger cells
    },
    y: {
      label: "Year and Emission Type",
      domain: [`${year} (Fossil Fuel)`, `${year} (Land-Use)`, `${year} (Total)`],
      paddingInner: 0.1 // Adjust spacing between rows for bigger cells
    },
    color: {
      type: "linear", //threshold
      domain: [-0.1, 0, 4, 8, 12], // Adjust the domain to handle negative values as well
      range: ["green", "white", "yellow" ,"orange" , "red"], // Using a diverging color scheme: green for negative, white for zero, red for positive
      label: "CO‚ÇÇ Emissions (billion tons)",
      legend: true,
      ticks: [-0.1, 0, 4, 8, 12],//d3.scaleLinear().domain([globalMinEmissions, 0, globalMaxEmissions]).ticks(5) 
      tickFormat: d3.format(".2f")
    },
    marks: [
      Plot.rect(heatmapData, { 
        x: "country", 
        y: "yearAndType", 
        fill: "emissions", 
        title: d => `${d.country}: ${d.emissions.toFixed(2)} billion tons`,
        tip: true,
        stroke: "black",
        strokeWidth: 0.1
      })
    ]
  });
  document.getElementById("heatmap-container").innerHTML = ""; // Clear previous plot
  document.getElementById("heatmap-container").appendChild(heatmap); // Append new plot
}

// Initialize the dropdown menu and initial heatmap
function initializeDropdown(data) {
  const years = [...new Set(data.map(d => d.Year))].sort((a, b) => a - b);
  const dropdown = document.getElementById("year-dropdown");
  dropdown.onchange = () => renderHeatmap(data, Number(dropdown.value));

  years.forEach(year => {
    const option = document.createElement("option");
    option.value = year;
    option.text = year;
    dropdown.appendChild(option);
  });

  renderHeatmap(data, years[0]); // Render the heatmap for the initial year
}

// Auto-play functionality to cycle through years
let autoPlayInterval;

function toggleAutoPlay(data) {
  const dropdown = document.getElementById("year-dropdown");
  const years = [...dropdown.options].map(option => Number(option.value));
  let currentIndex = years.indexOf(Number(dropdown.value));

  if (autoPlayInterval) {
    // Stop auto-play if it's already running
    clearInterval(autoPlayInterval);
    autoPlayInterval = null;
    document.getElementById("auto-play-button").innerText = "Auto Play";
  } else {
    // Start auto-play
    autoPlayInterval = setInterval(() => {
      // Check if the next year is greater than the current year
      const previousYear = years[currentIndex];
      currentIndex = (currentIndex + 1) % years.length;
      const currentYear = years[currentIndex];

      if (currentYear <= previousYear) {
        // Stop auto-play if the year does not increase
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
        document.getElementById("auto-play-button").innerText = "Auto Play";
      } else {
        // Update dropdown and heatmap with the new year
        dropdown.value = currentYear;
        renderHeatmap(data, currentYear);
      }
    }, 350); // Change year every 1 second
    document.getElementById("auto-play-button").innerText = "Stop";
  }
}

// Attach the toggleAutoPlay function to the button
document.getElementById("auto-play-button").onclick = () => toggleAutoPlay(datasetFossil);

// Call the initialize function with the dataset
initializeDropdown(datasetFossil);

return {prepareDataForYear,renderHeatmap,initializeDropdown,autoPlayInterval,toggleAutoPlay};
}});

</script>
</head>
<body>
<input id="observablehq-sidebar-toggle" type="checkbox" title="Toggle sidebar">
<label id="observablehq-sidebar-backdrop" for="observablehq-sidebar-toggle"></label>
<nav id="observablehq-sidebar">
  <ol>
    <label id="observablehq-sidebar-close" for="observablehq-sidebar-toggle"></label>
    <li class="observablehq-link"><a href="./">CO‚ÇÇ emissions</a></li>
  </ol>
  <ol>
    <li class="observablehq-link observablehq-link-active"><a href="./laboratory1">Comparing countries</a></li>
    <li class="observablehq-link"><a href="./laboratory2">Fossil vs Land</a></li>
    <li class="observablehq-link"><a href="./laboratory3">Don&#x27;t get confused by maps</a></li>
    <li class="observablehq-link"><a href="./laboratory4">laboratorio 4</a></li>
  </ol>
</nav>
<script>{const e=document.querySelector("#observablehq-sidebar"),t=document.querySelector("#observablehq-sidebar-toggle"),r=sessionStorage.getItem("observablehq-sidebar");r?t.checked=r==="true":t.indeterminate=!0;for(const o of document.querySelectorAll("#observablehq-sidebar summary")){const s=o.parentElement;switch(sessionStorage.getItem(`observablehq-sidebar:${o.textContent}`)){case"true":s.open=!0;break;case"false":s.classList.contains("observablehq-section-active")||(s.open=!1);break}}addEventListener("beforeunload",()=>sessionStorage.setItem("observablehq-sidebar-scrolly",`${e.scrollTop}`));const a=sessionStorage.getItem("observablehq-sidebar-scrolly");a!=null&&(e.style.cssText="overflow: hidden;",e.scrollTop=+a,e.style.cssText="");}</script>
<div id="observablehq-center">
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#country-comparison-over-the-years">Country Comparison over the years</a></li>
<li class="observablehq-secondary-link"><a href="#country-comparison-per-continent-in-2022">Country Comparison per continent in 2022</a></li>
<li class="observablehq-secondary-link"><a href="#co-emissions-comparison-per-type-fossil-land-use">CO‚ÇÇ emissions comparison per type (fossil/land-use)</a></li>
</ol>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<!-- Load the data -->
<div class="observablehq observablehq--block"><!--:f920bdb6:--></div>
<!-- BarPlot that show the emission and the country in one year -->
<h1 id="comparing-countries" tabindex="-1"><a class="observablehq-header-anchor" href="#comparing-countries">Comparing countries</a></h1>
<br>
<h2 id="country-comparison-over-the-years" tabindex="-1"><a class="observablehq-header-anchor" href="#country-comparison-over-the-years">Country Comparison over the years</a></h2>
<br>
<h3 id="top-20-countries-with-high-co-emissions-per-capita-over-the-years" tabindex="-1"><a class="observablehq-header-anchor" href="#top-20-countries-with-high-co-emissions-per-capita-over-the-years">Top 20 Countries with high CO‚ÇÇ Emissions Per Capita over the Years üåç</a></h3>
<div class="observablehq observablehq--block"><!--:08d4b376:--></div>
<div class="grid grid-cols-1"> 
  <div class="card"> <observablehq-loading></observablehq-loading><!--:c5890bb6:--> </div> 
</div>
<p> 
</p><p>Countries like <strong>Qatar</strong>, <strong>United Arab Emirates (UAE)</strong>, and <strong>Kuwait</strong> lead with exceptionally high emissions per capita, primarily due to their reliance on fossil fuel extraction and export.</p>
<p><strong>Australia</strong>, <strong>United States</strong>, and <strong>Canada</strong> follow closely, with emissions shaped by their high energy consumption, large geographical areas, and industrial economies.</p>
<p>Despite their small populations, <strong>Trinidad and Tobago</strong> and <strong>New Caledonia</strong> also have high emissions, primarily from fossil fuel use for energy and transport. <strong>Kazakhstan</strong> and <strong>Russia</strong> show lower emissions than the Gulf states and Western nations, but still exceed the global average. Meanwhile, <strong>Luxembourg</strong> maintains high emissions due to its industrial economy, while <strong>Palau</strong> stands out with lower emissions, thanks to its focus on tourism over heavy industry.</p>
<p></p>
<!-- BarPlot that show the emission and the country in one decade (2011 to 2022) -->
<br>
<h3 id="top-20-countries-with-high-co-emissions-per-capita-in-the-nearest-decade-2011-to-2022" tabindex="-1"><a class="observablehq-header-anchor" href="#top-20-countries-with-high-co-emissions-per-capita-in-the-nearest-decade-2011-to-2022">Top 20 Countries with high CO‚ÇÇ Emissions Per Capita in the nearest decade (2011 to 2022) üåç</a></h3>
<div class="observablehq observablehq--block"><!--:f90a5d74:--></div>
<div class="grid grid-cols-1"> 
  <div class="card"> <observablehq-loading></observablehq-loading><!--:a24953ee:--> </div> 
</div>
<p>
</p><p>From 2011 to 2022, countries like <strong>Qatar</strong>, <strong>Bahrain</strong>, and <strong>Kuwait</strong> consistently ranked at the top for CO‚ÇÇ emissions per capita, largely due to their heavy reliance on fossil fuel extraction and small, energy-intensive economies.</p>
<p><strong>Australia</strong>, <strong>United States</strong>, and <strong>Canada</strong> follow closely, with emissions driven by large industrial sectors and energy needs for vast geographical areas. While these countries are larger and more industrialized, their high consumption patterns still make their per capita emissions relatively high compared to global averages.</p>
<p>Meanwhile, <strong>Luxembourg</strong> and <strong>Faroe Islands</strong> stand out for their relatively high per capita emissions despite their small sizes.</p>
<p>In contrast, <strong>Palau</strong> shows a much lower carbon footprint. Its small population and tourism-based economy, which doesn‚Äôt rely on heavy industry, allow it to maintain one of the lowest per capita emissions on the list.</p>
<p>Overall, the data highlights a clear link between fossil fuel reliance, industrial activity, and high CO‚ÇÇ emissions, while also showing how small nations with less industrialization can maintain lower per capita emissions.</p>
<p></p>
<br>
<h2 id="country-comparison-per-continent-in-2022" tabindex="-1"><a class="observablehq-header-anchor" href="#country-comparison-per-continent-in-2022">Country Comparison per continent in 2022</a></h2>
<br>
<h3 id="continent-with-high-co-emissions" tabindex="-1"><a class="observablehq-header-anchor" href="#continent-with-high-co-emissions">Continent with high CO‚ÇÇ Emissions üåç</a></h3>
<div class="observablehq observablehq--block"><!--:ab7fc716:--></div>
<div class="grid grid-cols-1">
  <div class="card"> <observablehq-loading></observablehq-loading><!--:0f6b3f90:--> </div>
</div>
<p>
</p><p>In 2022, global CO‚ÇÇ emissions were dominated by key countries across continents.
<strong>China</strong> remains the world‚Äôs largest emitter, largely due to its vast manufacturing sector, reliance on coal, and the energy demands of its massive population. <strong>India</strong>, while having a lower per capita emission than China, continues to see rapid industrial growth and energy consumption, particularly in urban areas.</p>
<p>In North America, <strong>the USA</strong> continues to be a major emitter with emissions largely driven by energy consumption, transportation, and industrial sectors. <strong>Canada</strong>, with its vast landmass and reliance on energy-intensive industries like oil extraction, also ranks high in emissions per capita.</p>
<p><strong>Russia</strong> stands as Europe‚Äôs largest emitter, with emissions driven by its oil and natural gas extraction industries. <strong>Germany</strong>, Europe‚Äôs industrial powerhouse, also contributes heavily, particularly through manufacturing, transportation, and energy sectors.</p>
<p><strong>South Africa</strong> and <strong>Egypt</strong> are the top emitters in Africa. <strong>South Africa‚Äôs</strong> emissions are largely from coal-powered energy production, while <strong>Egypt</strong> has seen increasing emissions due to urbanization and energy demands.</p>
<p>In South America, <strong>Brazil</strong>‚Äôs emissions are shaped by deforestation, agriculture, and energy consumption, while <strong>Argentina</strong> also experiences high emissions due to its industrial sector and large-scale agriculture.</p>
<p><strong>Australia</strong> and <strong>New Zealand</strong> contribute heavily to emissions in Oceania, with <strong>Australia</strong>'s reliance on coal for energy and high per capita car usage. <strong>New Zealand</strong>, despite having a smaller population, has significant emissions from agriculture, particularly livestock.</p>
<p></p>
<br>
<h3 id="top-3-co-emitters-per-capita-per-continent" tabindex="-1"><a class="observablehq-header-anchor" href="#top-3-co-emitters-per-capita-per-continent">Top 3 CO‚ÇÇ emitters per capita per continent üåç</a></h3>
<div class="observablehq observablehq--block"><!--:40695053:--></div>
<div class="grid grid-cols-1">
  <div class="card"><observablehq-loading></observablehq-loading><!--:2832f044:--></div>
</div>
<p>
</p><p>In the previous chart we can visualize the top three CO‚ÇÇ emitters from each continent in 2022, highlighting key trends in energy consumption and industrialization.</p>
<p>In the top emitters per continent, the <strong>USA</strong> stands out as the largest emitter globally, with its massive industrial base, transportation sector, and high energy consumption. Following closely, <strong>India</strong> and <strong>Germany</strong> are the second largest emitters in their respective continents, driven by industrial activities and energy demands. <strong>Japan</strong> and the <strong>UK</strong> round out the third positions, reflecting their energy-intensive economies and reliance on fossil fuels, though Japan's emissions remain high due to its significant manufacturing sector.</p>
<p>This analysis suggests that <strong>Asia</strong> and <strong>Europe</strong> are the continents with the largest concentrations of emissions, with major contributors like the <strong>USA</strong>, <strong>India</strong>, and <strong>Germany</strong> leading the way. Their high emissions stem from a mix of industrialization, transportation, and energy production needs, showing a clear pattern where both population size and industrial output play crucial roles in continental CO‚ÇÇ emissions.</p>
<p></p>
<br>
<!-- Percentage of first graph rappresentation-->
<h3 id="continent-with-high-co-percentage-emissions" tabindex="-1"><a class="observablehq-header-anchor" href="#continent-with-high-co-percentage-emissions">Continent with high CO‚ÇÇ Percentage Emissions üåç</a></h3>
<div class="observablehq observablehq--block"><!--:2f881621:--></div>
<div class="grid grid-cols-1">
  <div class="card"> <observablehq-loading></observablehq-loading><!--:f17805dc:--> </div>
</div>
<p>
</p><p>In Asia, <strong>China</strong> is responsible for 52.18% of the continent's CO‚ÇÇ emissions, highlighting its role as the largest emitter in the world. In <strong>North America</strong>, the <strong>USA</strong> accounts for a staggering 80.27% of emissions, driven by its high energy consumption, transportation sector, and industrial activities. In <strong>Europe</strong>, <strong>Russia</strong> contributes 32.57% of emissions, with <strong>Germany</strong> following at 13.26%, reflecting their large industrial bases and energy needs.</p>
<p>In <strong>Africa</strong>, <strong>South Africa</strong> is the leading emitter with 29.19%, while <strong>Egypt</strong> contributes 17.45%. <strong>Brazil</strong> accounts for 44.39% of <strong>South America's</strong> emissions, with <strong>Argentina</strong> contributing 17.96%. In <strong>Oceania</strong>, <strong>Australia</strong> dominates, responsible for 89.06% of the continent's emissions.</p>
<p></p>
<br>
<h2 id="co-emissions-comparison-per-type-fossil-land-use" tabindex="-1"><a class="observablehq-header-anchor" href="#co-emissions-comparison-per-type-fossil-land-use">CO‚ÇÇ emissions comparison per type (fossil/land-use)</a></h2>
<br>
<h3 id="co-emissions-heatmap" tabindex="-1"><a class="observablehq-header-anchor" href="#co-emissions-heatmap">CO‚ÇÇ Emissions Heatmap üåç</a></h3>
<div class="observablehq observablehq--block"><!--:5115dc54:--></div>
<div class="grid grid-cols-1"> 
  <div class="card">
    <div id="dropdown-container" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px;">
      <span>Select a year to view CO‚ÇÇ emissions by country:</span> 
      <select id="year-dropdown"></select> <!-- Dropdown for years -->
      <button id="auto-play-button">Auto Play</button> <!-- Auto Play button -->
    </div>
    <div id="heatmap-container"></div>
  </div> 
</div>
<p>
</p><p>The heatmap visually represents the share of CO‚ÇÇ emissions coming from <em>fossil fuels</em> versus <em>land-use changes</em> across different countries. In this heatmap, continents where <em>fossil fuel emissions</em> dominate are shown with deeper shades of red, indicating a higher contribution to total emissions from industries such as energy production, transportation, and manufacturing. On the other hand, areas where <em>land-use emissions</em>, such as deforestation and agriculture, play a larger role are highlighted in shades of green, indicating their significant impact on global CO‚ÇÇ levels due to land transformation and vegetation loss.</p>
<p>Countries with large industrial economies and high energy consumption, such as the <strong>USA</strong>, <strong>China</strong>, and <strong>India</strong>, dominate the red spectrum. These nations rely heavily on fossil fuels for electricity, heating, transportation, and manufacturing, driving the bulk of their emissions from these sources. <strong>Europe</strong> also shows significant fossil fuel emissions, particularly in industrialized nations like <strong>Germany</strong> and <strong>Russia</strong>.</p>
<p>Countries with significant land-use emissions are those with large agricultural sectors or high rates of deforestation. <strong>Brazil</strong> stands out in South America, where deforestation of the Amazon contributes massively to carbon emissions. Similarly, <strong>Indonesia</strong> also shows strong land-use emissions. These emissions primarily result from agricultural practices, land clearing for agriculture, and changes in forest cover.</p>
<p>This heatmap reveals a global landscape where <strong>fossil fuel consumption</strong> is the dominant source of emissions in highly industrialized countries, whereas <strong>land-use changes</strong> emerge as a major source in continents with extensive agricultural practices or deforestation. Understanding the distribution of these emission types is crucial for shaping climate policies, as addressing fossil fuel emissions may require different strategies than tackling emissions from land-use changes.</p>
<p></p></main>
<footer id="observablehq-footer">
<nav><a rel="prev" href="./"><span>CO‚ÇÇ emissions</span></a><a rel="next" href="./laboratory2"><span>Fossil vs Land</span></a></nav>
<div>Built with <a href="https://observablehq.com/" target="_blank" rel="noopener noreferrer">Observable</a> on <a title="2024-12-22T23:52:07">Dec 22, 2024</a>.</div>
</footer>
</div>
</body>
</html>
