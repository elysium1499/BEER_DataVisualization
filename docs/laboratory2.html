<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.0">
<title>Laboratory Two | DataVisualization</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="modulepreload" href="./_observablehq/client.7782eb36.js">
<link rel="modulepreload" href="./_observablehq/runtime.9393ab6d.js">
<link rel="modulepreload" href="./_observablehq/stdlib.3ee9cb94.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="icon" href="./_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.7782eb36.js";
import {registerFile} from "./_observablehq/stdlib.3ee9cb94.js";

registerFile("./data/new_filtered_co2_data.csv", {"name":"./data/new_filtered_co2_data.csv","mimeType":"text/csv","path":"./_file/data/new_filtered_co2_data.8fc3b953.csv","lastModified":1731584762291,"size":345920});

define({id: "7cb0146e", inputs: ["FileAttachment"], outputs: ["d3","sankey","sankeyLinkHorizontal","datasetFossil","dataYear2000","ContinentCountryEmissionSankeyChart"], body: async (FileAttachment) => {
// Import necessary D3 libraries
const [d3, { sankey, sankeyLinkHorizontal }] = await Promise.all([
  import("https://cdn.jsdelivr.net/npm/d3@7/+esm"),
  import("https://cdn.jsdelivr.net/npm/d3-sankey@0.12/+esm")
]);

// Load and process the dataset
const datasetFossil = await FileAttachment("./data/new_filtered_co2_data.csv").csv({ typed: true });
console.log("Loaded data:", datasetFossil);  // Check if data is loaded

// Filter data for the year 2000 and select top 30 countries by CO₂ emissions
const dataYear2000 = datasetFossil
  .filter(d => d.Year === 2000)  // Filter for the year 2000
  .sort((a, b) => b["Annual CO₂ emissions"] - a["Annual CO₂ emissions"])  // Sort by emissions, descending
  .slice(0, 30);  // Select top 30 countries
console.log("Data for year 2000:", dataYear2000);  // Check filtered data

// Define the chart function to connect continents to countries and countries to emission types
function ContinentCountryEmissionSankeyChart(data, width, height = 600) {
  const continentNodes = [];  // Layer 1: Continent nodes
  const countryNodes = [];    // Layer 2: Country nodes
  const typeNodes = [{ name: "Fossil Use" }, { name: "Land Use" }];  // Layer 3: Emission types
  const links = [];

  // Step 1: Create unique continent nodes
  const uniqueContinents = Array.from(new Set(data.map(d => d.Region)));
  uniqueContinents.forEach(continent => {
    continentNodes.push({ name: continent });
  });

  // Step 2: Create country nodes and links from continent to country
  data.forEach(d => {
    const countryName = d.Entity;
    const continentName = d.Region;

  // Add country node if it doesn't exist
  if (!countryNodes.some(node => node.name === countryName)) {
    countryNodes.push({ name: countryName });
  }


    // Create link from continent to country based on total emissions
    links.push({
      source: continentName,
      target: countryName,
      value: d["Annual CO₂ emissions"]
    });
  });

  // Step 3: Link each country to "Fossil Use" and "Land Use" nodes for specific emission types
  data.forEach(d => {
    const countryName = d.Entity;

    // Link to Fossil emissions if applicable
    if (d["Annual CO₂ emissions"] > 0) {
      links.push({
        source: countryName,
        target: "Fossil Use",
        value: d["Annual CO₂ emissions"]
      });
    }

    // Link to Land Use emissions if applicable
    if (d["Annual CO₂ emissions from land-use change"] > 0) {
      links.push({
        source: countryName,
        target: "Land Use",
        value: d["Annual CO₂ emissions from land-use change"]
      });
    }
  });

  // Combine nodes for Sankey setup
  const nodes = [...continentNodes, ...countryNodes, ...typeNodes];

  // Set up the Sankey diagram
  const color = d3.scaleOrdinal(d3.schemeCategory10);

  const { nodes: sankeyNodes, links: sankeyLinks } = sankey()
    .nodeWidth(30)
    .nodePadding(7)
    .extent([[1, 1], [width - 1, height - 6]])({
      nodes: nodes.map(d => ({ ...d })),
      links: links.map(d => ({
        source: nodes.findIndex(n => n.name === d.source),
        target: nodes.findIndex(n => n.name === d.target),
        value: d.value
      }))
    });

  // Create the SVG element
  const svg = d3.create("svg")
    .attr("viewBox", [0, 0, width, height])
    .attr("width", width)
    .attr("height", height)
    .style("min-height", "600px")
    .style("font", "10px sans-serif");

  // Add nodes
  svg.append("g")
    .selectAll("rect")
    .data(sankeyNodes)
    .join("rect")
    .attr("x", d => d.x0)
    .attr("y", d => d.y0)
    .attr("height", d => d.y1 - d.y0)
    .attr("width", d => d.x1 - d.x0)
    .attr("fill", d => color(d.name))
    .append("title")
    .text(d => `${d.name}\n${d.value ? d.value.toLocaleString() : ""}`);

  // Add links
  svg.append("g")
    .attr("fill", "none")
    .selectAll("path")
    .data(sankeyLinks)
    .join("path")
    .attr("d", sankeyLinkHorizontal())
    .attr("stroke", d => color(d.source.name))
    .attr("stroke-width", d => Math.max(1, d.width))
    .attr("opacity", 0.5)
    .append("title")
    .text(d => `${d.source.name} → ${d.target.name}\n${d.value.toLocaleString()}`);

  // Add text labels
  svg.append("g")
    .style("font", "10px sans-serif")
    .selectAll("text")
    .data(sankeyNodes)
    .join("text")
    .attr("x", d => (d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6))
    .attr("y", d => (d.y0 + d.y1) / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", d => (d.x0 < width / 2 ? "start" : "end"))
    .text(d => d.name);

  return svg.node();
}

return {d3,sankey,sankeyLinkHorizontal,datasetFossil,dataYear2000,ContinentCountryEmissionSankeyChart};
}});

define({id: "dd50f1f2", mode: "inline", inputs: ["ContinentCountryEmissionSankeyChart","dataYear2000","display"], body: async (ContinentCountryEmissionSankeyChart,dataYear2000,display) => {
display(await(
ContinentCountryEmissionSankeyChart(dataYear2000, 800)
))
}});

</script>
</head>
<body>
<input id="observablehq-sidebar-toggle" type="checkbox" title="Toggle sidebar">
<label id="observablehq-sidebar-backdrop" for="observablehq-sidebar-toggle"></label>
<nav id="observablehq-sidebar">
  <ol>
    <label id="observablehq-sidebar-close" for="observablehq-sidebar-toggle"></label>
    <li class="observablehq-link"><a href="./">DataVisualization</a></li>
  </ol>
  <ol>
    <li class="observablehq-link"><a href="./laboratory1">Laboratory One</a></li>
    <li class="observablehq-link observablehq-link-active"><a href="./laboratory2">Laboratory Two</a></li>
  </ol>
</nav>
<script>{const e=document.querySelector("#observablehq-sidebar"),t=document.querySelector("#observablehq-sidebar-toggle"),r=sessionStorage.getItem("observablehq-sidebar");r?t.checked=r==="true":t.indeterminate=!0;for(const o of document.querySelectorAll("#observablehq-sidebar summary")){const s=o.parentElement;switch(sessionStorage.getItem(`observablehq-sidebar:${o.textContent}`)){case"true":s.open=!0;break;case"false":s.classList.contains("observablehq-section-active")||(s.open=!1);break}}addEventListener("beforeunload",()=>sessionStorage.setItem("observablehq-sidebar-scrolly",`${e.scrollTop}`));const a=sessionStorage.getItem("observablehq-sidebar-scrolly");a!=null&&(e.style.cssText="overflow: hidden;",e.scrollTop=+a,e.style.cssText="");}</script>
<div id="observablehq-center">
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#data-and-chart-setup">Data and Chart Setup</a></li>
</ol>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<h1 id="section-2-alluvial" tabindex="-1"><a class="observablehq-header-anchor" href="#section-2-alluvial">Section 2: Alluvial</a></h1>
<br>
<h2 id="data-and-chart-setup" tabindex="-1"><a class="observablehq-header-anchor" href="#data-and-chart-setup">Data and Chart Setup</a></h2>
<div class="observablehq observablehq--block"><!--:7cb0146e:--></div>
<div class="grid grid-cols-1"> 
  <div class="card"> <observablehq-loading></observablehq-loading><!--:dd50f1f2:--></div> 
</div></main>
<footer id="observablehq-footer">
<nav><a rel="prev" href="./laboratory1"><span>Laboratory One</span></a></nav>
<div>Built with <a href="https://observablehq.com/" target="_blank" rel="noopener noreferrer">Observable</a> on <a title="2024-11-14T17:07:28">Nov 14, 2024</a>.</div>
</footer>
</div>
</body>
</html>
